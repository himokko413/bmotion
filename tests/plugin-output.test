# vim: ft=tcl
source "tests/eggdrop-shim.tcl"

set botnick "NoTopic"
set bMotionRoot "."

source "bMotion.tcl"

package require tcltest
namespace import ::tcltest::*

eval ::tcltest::configure $argv

test output-mood-1 "mood plugin adjusts mood up" -setup {
    bMotion_mood_set happy 0
} -body {
    set line "test1 %MOOD{happy:1} test2"
    set line [bMotion_plugin_output_MOOD "#molsoft" $line]
    return [bMotion_mood_get happy]
} -result {1}


test output-mood-2 "mood plugin removes matching text from output" -setup {
    bMotion_mood_set happy 0
} -body {
    set line "test1 %MOOD{happy:1} test2"
    set line [bMotion_plugin_output_MOOD "#molsoft" $line]
    return $line
} -result {test1  test2}



test output-mood-2 "mood plugin adjusts mood down" -setup {
    bMotion_mood_set happy 0
} -body {
    set line "test1 %MOOD{happy:-1} test2"
    set line [bMotion_plugin_output_MOOD "#molsoft" $line]
    return [bMotion_mood_get happy]
} -result {-1}


test output-number-1 "number plugin with single param outputs a number" -setup {
    shim_load_rng [list 5]
} -body {
    return [bMotion_plugin_output_NUMBER "#molsoft" "a %NUMBER{10} b"]
} -result {a 6 b}


test output-number-2 "number plugin with double param outputs a number with padding" -setup {
    shim_load_rng [list 4]
} -body {
    return [bMotion_plugin_output_NUMBER "#molsoft" "a %NUMBER{10}{3} b"]
} -result {a 005 b}


test output-owner-1 "owner plugin works" -body {
    return [bMotion_plugin_output_OWNER "#molsoft" "a %OWNER{test} b"]
} -result {a test's b}


test output-plural-1 "plural plugin works" -body {
    return [bMotion_plugin_output_PLURAL "#molsoft" "a %PLURAL{test} b"]
} -result {a tests b}


test output-repeat-1 "repeat plugin works" -setup {
    shim_load_rng [list 3]
} -body {
    return [bMotion_plugin_output_REPEAT "#molsoft" "a %REPEAT{1:5:a} b"]
} -result {a aaaa b}


test output-setting-1 "setting plugin works" -setup {
    bMotion_plugins_settings_set "complex:test" "test-setting" "test-channel" "test-nick" "moo"
} -body {
    return [bMotion_plugin_output_SETTING "#molsoft" "a %SETTING{complex:test:test-setting:test-channel:test-nick} b"]
} -result {a moo b}


test output-setting-2 "setting plugin kills output with malformated request" -body {
    return [bMotion_plugin_output_SETTING "#molsoft" "a %SETTING{blah} b"]
} -result {}


test output-setting-3 "setting plugin kills output with missing setting" -body {
    return [bMotion_plugin_output_SETTING "#molsoft" "a %SETTING{complex:test:test-setting:test-fail:test-nick} b"]
} -result {}


test output-smiley-1 "smiley plugin works with SMILEY" -setup {
    set ::bMotionSettings(smiley_type) "paren"
} -body {
    return [bMotion_plugin_output_SMILEY "#molsoft" "a %SMILEY{smile} b"]
} -result {a :) b}


test output-smiley-2 "smiley plugin works with SMILE" -setup {
    set ::bMotionSettings(smiley_type) "paren"
} -body {
    return [bMotion_plugin_output_SMILEY "#molsoft" "a %SMILE{smile} b"]
} -result {a :) b}


test output-time-1 "time plugin works" -body {
    return [bMotion_plugin_output_TIME "#molsoft" "a %TIME{10:00:00 01/01/1980} b"]
} -result {a 10:00 AM b}


test output-var-1 "VAR plugin works" -setup {
    bMotion_abstract_register "test"
    bMotion_abstract_reset "test"
    bMotion_abstract_add "test" "hello"
} -body {
    return [bMotion_plugin_output_VAR "#molsoft" "%VAR{test}"]
} -result {hello}


test output-var-2 "VAR plugin understands %noun" -setup {
    bMotion_abstract_reset "sillyThings"
    bMotion_abstract_add "sillyThings" "sillythings test"
} -body {
    return [bMotion_plugin_output_VAR "#molsoft" "%noun"]
} -result {sillythings test}


test output-var-3 "VAR plugin understands old {strip}" -setup {
    bMotion_abstract_register "test2" [list "a test"]
} -body {
    return [bMotion_plugin_output_VAR "#molsoft" "%VAR{test2}{strip}"]
} -result {test}


test output-var-4 "VAR plugin revmixin works with male bot" -setup {
    bMotion_abstract_register "test_female"
    bMotion_abstract_reset "test_female"
    bMotion_abstract_add "test_female" "test-female"
    bMotion_abstract_reset "test"
    set ::bMotionSettings(gender) "male"
} -body {
    return [bMotion_plugin_output_VAR "#molsoft" "%VAR{test:revmixin}"]
} -result "test-female"


test output-var-5 "VAR plugin revmixin works with female bot" -setup {
    set ::bMotion_log_level 5
    bMotion_abstract_register "test_male"
    bMotion_abstract_reset "test_male"
    bMotion_abstract_add "test_male" "test-male"
    bMotion_abstract_reset "test"
    set ::bMotionSettings(gender) "female"
} -body {
    return [bMotion_plugin_output_VAR "#molsoft" "%VAR{test:revmixin}"]
} -result "test-male"



test output-var-6 "VAR plugin default mixin works with female bot" -setup {
    bMotion_abstract_register "test_female"
    bMotion_abstract_reset "test_female"
    bMotion_abstract_add "test_female" "test-female"
    bMotion_abstract_reset "test"
    set ::bMotionSettings(gender) "female"
} -body {
    return [bMotion_plugin_output_VAR "#molsoft" "%VAR{test}"]
} -result "test-female"


test output-var-7 "VAR plugin default mixin works with male bot" -setup {
    bMotion_abstract_register "test_male"
    bMotion_abstract_reset "test_male"
    bMotion_abstract_add "test_male" "test-male"
    bMotion_abstract_reset "test"
    set ::bMotionSettings(gender) "male"
} -body {
    return [bMotion_plugin_output_VAR "#molsoft" "%VAR{test}"]
} -result "test-male"


cleanupTests
