# vim: ft=tcl
source "tests/eggdrop-shim.tcl"

set botnick "NoTopic"
set bMotionRoot "."

source "bMotion.tcl"

package require tcltest
namespace import ::tcltest::*

eval ::tcltest::configure $argv

test output-mood-1 "mood plugin adjusts mood up" -setup {
    bMotion_mood_set happy 0
} -body {
    set line "test1 %MOOD{happy:1} test2"
    set line [bMotion_plugin_output_MOOD "#molsoft" $line]
    return [bMotion_mood_get happy]
} -result {1}


test output-mood-2 "mood plugin removes matching text from output" -setup {
    bMotion_mood_set happy 0
} -body {
    set line "test1 %MOOD{happy:1} test2"
    set line [bMotion_plugin_output_MOOD "#molsoft" $line]
    return $line
} -result {test1  test2}



test output-mood-2 "mood plugin adjusts mood down" -setup {
    bMotion_mood_set happy 0
} -body {
    set line "test1 %MOOD{happy:-1} test2"
    set line [bMotion_plugin_output_MOOD "#molsoft" $line]
    return [bMotion_mood_get happy]
} -result {-1}


test output-number-1 "number plugin with single param outputs a number" -setup {
    shim_load_rng [list 5]
} -body {
    return [bMotion_plugin_output_NUMBER "#molsoft" "a %NUMBER{10} b"]
} -result {a 6 b}


test output-number-2 "number plugin with double param outputs a number with padding" -setup {
    shim_load_rng [list 4]
} -body {
    return [bMotion_plugin_output_NUMBER "#molsoft" "a %NUMBER{10}{3} b"]
} -result {a 005 b}


test output-owner-1 "owner plugin works" -body {
    return [bMotion_plugin_output_OWNER "#molsoft" "a %OWNER{test} b"]
} -result {a test's b}


test output-plural-1 "plural plugin works" -body {
    return [bMotion_plugin_output_PLURAL "#molsoft" "a %PLURAL{test} b"]
} -result {a tests b}


test output-repeat-1 "repeat plugin works" -setup {
    shim_load_rng [list 3]
} -body {
    return [bMotion_plugin_output_REPEAT "#molsoft" "a %REPEAT{1:5:a} b"]
} -result {a aaaa b}


test output-setting-1 "setting plugin works" -setup {
    bMotion_plugins_settings_set "complex:test" "test-setting" "test-channel" "test-nick" "moo"
} -body {
    return [bMotion_plugin_output_SETTING "#molsoft" "a %SETTING{complex:test:test-setting:test-channel:test-nick} b"]
} -result {a moo b}


test output-setting-2 "setting plugin kills output with malformated request" -body {
    return [bMotion_plugin_output_SETTING "#molsoft" "a %SETTING{blah} b"]
} -result {}


test output-setting-3 "setting plugin kills output with missing setting" -body {
    return [bMotion_plugin_output_SETTING "#molsoft" "a %SETTING{complex:test:test-setting:test-fail:test-nick} b"]
} -result {}


cleanupTests
